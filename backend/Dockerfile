# ========================================
# üë∑ Stage 1: Build with Gradle + Temurin
# ========================================
FROM eclipse-temurin:21-jdk-alpine AS builder

# ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Gradle ‡∏î‡πâ‡∏ß‡∏¢ SDKMAN ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏à‡∏Å‡∏à‡πà‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ wrapper
# ‡∏Å‡∏£‡∏ì‡∏µ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ Gradle Wrapper ‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå
WORKDIR /app

# ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å Gradle wrapper ‡∏Å‡πà‡∏≠‡∏ô (‡∏à‡∏∞‡πÑ‡∏î‡πâ cache ‡πÑ‡∏î‡πâ)
COPY gradlew .
COPY gradle ./gradle

# ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå build ‡πÅ‡∏•‡∏∞ dependency ‡∏ï‡πà‡∏≤‡∏á ‡πÜ
COPY build.gradle settings.gradle ./

# Download dependencies ‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ (optional optimization)
RUN ./gradlew dependencies --no-daemon || return 0

# ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å source code ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠
COPY . .

# ‡∏™‡∏£‡πâ‡∏≤‡∏á jar
RUN ./gradlew bootJar --no-daemon

# ========================================
# üöÄ Stage 2: Run with Temurin JDK only
# ========================================
FROM eclipse-temurin:21-jdk-alpine

WORKDIR /app

COPY --from=builder /app/build/libs/*.jar app.jar

EXPOSE 8080

ENTRYPOINT ["java", "-jar", "app.jar"]
